"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var NavController=function(){function e(){_classCallCheck(this,e),this.arrowIcon=document.querySelector(".icon.angle.left"),this.friendFinder=document.querySelector(".locations"),this.body=document.body,this._manageEvents()}return _createClass(e,[{key:"_manageEvents",value:function(){var t=this;this.arrowIcon.addEventListener("click",function(e){t.friendFinder.classList.toggle("open")}),this.friendFinder.addEventListener("click",function(e){e.stopPropagation()}),this.body.addEventListener("click",function(){t.friendFinder.classList.remove("open")})}}]),e}(),navController=new NavController;function initMap(){new MapController}var MapController=function(){function e(){_classCallCheck(this,e),this.map,this.places,this.markers=[],this.geocoder,this.locations=[],this.addresses=[],this.funMarkers=[],this.infoWindow,this.autocomplete,this.funLocations=[],this.funTypes_UserOverride,this.funButton=document.querySelector(".fun-finder-sec__fun-btn"),this.searchButton=document.querySelector("button.search"),this.locateButton=document.querySelector("button.locateButton"),this.LONDON_ZOOM=12,this.DEFAULT_RADIUS=1e3,this.FH_TIMEOUT=700,this.CENTER_TIMEOUT=2300,this.ERROR_TIMEOUT=2500,this.SPY_SRC="/static/mapper/avatars/ninja.6879220b2dbd.png",this.LONDON_CENTER={lat:51.505,lng:-.123},this.FUN_PLACE_CATEGORIES=["Attractions","Out & About","Adventure","Night Life","Smarts & Arts","Wellness"],this.FUN_PLACE_TYPES=["amusement_park","aquarium","art_gallery","bakery","bar","beauty_salon","book_store","bowling_alley","cafe","campground","car_rental","casino","gym","library","movie_theater","museum","night_club","park","restaurant","rv_park","shopping_mall","spa","stadium","zoo"],this.FUN_PLACE_TYPES_AND_CATEGORIES=[{type:this.FUN_PLACE_TYPES[0],category:this.FUN_PLACE_CATEGORIES[2]},{type:this.FUN_PLACE_TYPES[1],category:this.FUN_PLACE_CATEGORIES[0]},{type:this.FUN_PLACE_TYPES[2],category:this.FUN_PLACE_CATEGORIES[4]},{type:this.FUN_PLACE_TYPES[3],category:this.FUN_PLACE_CATEGORIES[1]},{type:this.FUN_PLACE_TYPES[4],category:this.FUN_PLACE_CATEGORIES[3]},{type:this.FUN_PLACE_TYPES[5],category:this.FUN_PLACE_CATEGORIES[5]},{type:this.FUN_PLACE_TYPES[6],category:this.FUN_PLACE_CATEGORIES[4]},{type:this.FUN_PLACE_TYPES[7],category:this.FUN_PLACE_CATEGORIES[3]},{type:this.FUN_PLACE_TYPES[8],category:this.FUN_PLACE_CATEGORIES[1]},{type:this.FUN_PLACE_TYPES[9],category:this.FUN_PLACE_CATEGORIES[2]},{type:this.FUN_PLACE_TYPES[10],category:this.FUN_PLACE_CATEGORIES[2]},{type:this.FUN_PLACE_TYPES[11],category:this.FUN_PLACE_CATEGORIES[0]},{type:this.FUN_PLACE_TYPES[12],category:this.FUN_PLACE_CATEGORIES[5]},{type:this.FUN_PLACE_TYPES[13],category:this.FUN_PLACE_CATEGORIES[4]},{type:this.FUN_PLACE_TYPES[14],category:this.FUN_PLACE_CATEGORIES[3]},{type:this.FUN_PLACE_TYPES[15],category:this.FUN_PLACE_CATEGORIES[0]},{type:this.FUN_PLACE_TYPES[16],category:this.FUN_PLACE_CATEGORIES[3]},{type:this.FUN_PLACE_TYPES[17],category:this.FUN_PLACE_CATEGORIES[0]},{type:this.FUN_PLACE_TYPES[18],category:this.FUN_PLACE_CATEGORIES[1]},{type:this.FUN_PLACE_TYPES[19],category:this.FUN_PLACE_CATEGORIES[2]},{type:this.FUN_PLACE_TYPES[20],category:this.FUN_PLACE_CATEGORIES[1]},{type:this.FUN_PLACE_TYPES[21],category:this.FUN_PLACE_CATEGORIES[5]},{type:this.FUN_PLACE_TYPES[22],category:this.FUN_PLACE_CATEGORIES[0]},{type:this.FUN_PLACE_TYPES[23],category:this.FUN_PLACE_CATEGORIES[0]}],this.MARKER_PATH="https://developers.google.com/maps/documentation/javascript/images/marker_green",this.CLUSTER_IMAGE="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",this._getUserPreferences(),this._createMap()}return _createClass(e,[{key:"_getUserPreferences",value:function(){var e=document.getElementById("mapScript").getAttribute("data-user-interests");e&&(this.funTypes_UserOverride=JSON.parse(e))}},{key:"_createMap",value:function(){this.map=new google.maps.Map(document.getElementById("map"),{center:this.LONDON_CENTER,zoom:this.LONDON_ZOOM,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,backgroundColor:"rgb(242, 255, 254)"}),this.geocoder=new google.maps.Geocoder;var e=this;this.locateButton.addEventListener("click",function(){e._geolocateUser()},{once:!0}),this.searchButton.addEventListener("click",function(){e._searchFunctionality()},{once:!0}),this.funButton.addEventListener("click",function(){return e._funSearch()})}},{key:"_geolocateUser",value:function(){var o=this;this._loadingGeolocation(),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude};o.locations.push({coords:t}),o._hideLocatorButtons(),setTimeout(function(){o._createAutocomplete(),o._addFriendHolder(t,o.SPY_SRC)},o.FH_TIMEOUT),o._createMarkerClusterer()},function(){o.infoWindow=new google.maps.InfoWindow,o._handleLocationError(!0,o.infoWindow,o.map.getCenter())}):(this.infoWindow=new google.maps.InfoWindow,this._handleLocationError(!1,this.infoWindow,this.map.getCenter()))}},{key:"_loadingGeolocation",value:function(){document.querySelector(".locateButton").classList.add("loading")}},{key:"_hideLocatorButtons",value:function(){var e=document.querySelector("#locator"),t=document.querySelector(".locateButton");t.classList.remove("loading","geo"),t.textContent="",t.classList.add("shrink"),setTimeout(function(){return e.classList.add("hidden")},this.FH_TIMEOUT)}},{key:"_createAutocomplete",value:function(){this._createsearchInput();var e=document.getElementById("autocomplete");e.focus(),this.autocomplete=new google.maps.places.Autocomplete(e),this.places=new google.maps.places.PlacesService(this.map);var t=this;this.autocomplete.addListener("place_changed",function(){return t._onPlaceChanged(e)})}},{key:"_createsearchInput",value:function(){document.querySelector("#search").classList.remove("hidden")}},{key:"_onPlaceChanged",value:function(e){var t=this.autocomplete.getPlace();if(e.value="",e.focus(),t&&t.geometry&&t.geometry.location){var o=t.geometry.location.toJSON();this.locations.push({coords:o}),this._createMarkerClusterer(),this._addFriendHolder(o)}}},{key:"_createMarkerClusterer",value:function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=this.locations.length-1,o=this.locations[t],n=e[t%e.length];o.label=n,this.markers.push(new google.maps.Marker({position:o.coords,label:n,animation:google.maps.Animation.DROP}));new MarkerClusterer(this.map,this.markers,{imagePath:this.CLUSTER_IMAGE});this._setZoomAndCenter(this.locations)}},{key:"_setZoomAndCenter",value:function(e,t){var o=this;if(!t);var n=new google.maps.LatLngBounds;e.forEach(function(e){var t=new google.maps.LatLng({lat:e.coords.lat,lng:e.coords.lng});n.extend(t)}),1===e.length?setTimeout(function(){o.map.setCenter(n.getCenter()),o.map.setZoom(18)},t):setTimeout(function(){o.map.setCenter(n.getCenter()),o.map.fitBounds(n,60)},t)}},{key:"_addFriendHolder",value:function(e,t){var l,u=this,o=document.querySelector(".locator-parent"),n=document.querySelector("#clone"),d=n.cloneNode(!0);d.classList.remove("hidden"),d.id="",this.geocoder.geocode({location:e},function(e,t){if(t===google.maps.GeocoderStatus.OK){if(e[0].formatted_address){u.addresses.push(e[0].formatted_address);var o=e[0].address_components,n=!0,i=!1,r=void 0;try{for(var s,a=o[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var c=s.value;if(c.types.includes("country")){l=c.short_name,u._setCountryAndUnhideFunFinder(l);break}}}catch(e){i=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw r}}}else u.addresses.push("Not available...");d.children[0].children[1].children[0].textContent=u.addresses[u.addresses.length-1]}}),t&&(d.children[0].children[0].src=t);o.insertBefore(d,n)}},{key:"_searchFunctionality",value:function(e){var t=this;this._hideLocatorButtons(),setTimeout(function(){return t._createAutocomplete()},this.FH_TIMEOUT),e&&setTimeout(function(){return t.infoWindow.close()},this.ERROR_TIMEOUT)}},{key:"_setCountryAndUnhideFunFinder",value:function(e){if(1===this.locations.length){this._setCountryRestriction(e);var t=document.getElementById("reloadMap"),o=document.getElementById("autocomplete");t.classList.remove("disabled"),t.classList.add("pointer"),t.addEventListener("click",function(){window.location.reload()}),o.placeholder="Where are your friends?"}else if(2===this.locations.length){document.getElementById("fun-finder-div").classList.remove("hidden")}}},{key:"_setCountryRestriction",value:function(e){var t={country:e};this.autocomplete.setOptions({componentRestrictions:t})}},{key:"_handleLocationError",value:function(e,t,o){t.setPosition(o),t.setContent(e?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation."),t.open(this.map),this._searchFunctionality(!0)}},{key:"_funSearch",value:function(i){var r=this,s=this;this.infoWindow=new google.maps.InfoWindow({content:document.getElementById("info-content")});var e={location:s.map.getCenter(),radius:i||s.DEFAULT_RADIUS,type:s.funTypes_UserOverride||s.FUN_PLACE_TYPES,openNow:!0,rankBy:google.maps.places.RankBy.PROMINENCE};this.places.nearbySearch(e,function(n,e){if(e===google.maps.places.PlacesServiceStatus.OK){if(n.length<5)return void r._reSearch(i);for(var t=function(t){var e=String.fromCharCode("A".charCodeAt(0)+t%26),o=r.MARKER_PATH+e+".png";r.funMarkers[t]=new google.maps.Marker({position:n[t].geometry.location,animation:google.maps.Animation.DROP,icon:o}),r.funLocations.push({coords:n[t].geometry.location.toJSON(),label:e}),r.funMarkers[t].placeResult=n[t],google.maps.event.addListener(s.funMarkers[t],"click",function(){var e=s.funMarkers[t];s._showInfoWindow(e)}),setTimeout(function(){r.funMarkers[t].setMap(r.map)},100*t)},o=0;o<5;o++)t(o);r._setZoomAndCenter(r.funLocations,r.CENTER_TIMEOUT),r._closeFriendFinder()}else r._reSearch(i)})}},{key:"_closeFriendFinder",value:function(){document.querySelector(".locations").classList.remove("open")}},{key:"_showInfoWindow",value:function(o){var n=this;this.places.getDetails({placeId:o.placeResult.place_id},function(e,t){t===google.maps.places.PlacesServiceStatus.OK&&(n.infoWindow.open(n.map,o),n._buildIWContent(e))})}},{key:"_buildIWContent",value:function(e){if(document.getElementById("iw-icon").innerHTML='<img class="funPlaceIcon" src="'+e.icon+'"/>',document.getElementById("iw-url").innerHTML='<b><a href="'+e.url+'">'+e.name+"</a></b>",document.getElementById("iw-address").textContent=e.vicinity,e.formatted_phone_number?(document.getElementById("iw-phone-row").style.display="",document.getElementById("iw-phone").textContent=e.formatted_phone_number):document.getElementById("iw-phone-row").style.display="none",e.rating)for(var t="",o=0;o<5;o++)e.rating<o+.5?t+="&#10025;":t+="&#10029;",document.getElementById("iw-rating-row").style.display="",document.getElementById("iw-rating").innerHTML=t;else document.getElementById("iw-rating-row").style.display="none";if(e.website){var n=new RegExp("^https?://.+?/"),i=(e.website,n.exec(e.website));null===i&&(i="http://"+e.website+"/"),document.getElementById("iw-website-row").style.display="",document.getElementById("iw-website").textContent=i}else document.getElementById("iw-website-row").style.display="none"}},{key:"_reSearch",value:function(e){var t;t=e?1.5*e:1.5*this.DEFAULT_RADIUS,this._funSearch(t)}}]),e}();